---
import "@styles/print.css";
import "@styles/global.css";
import "@styles/background.css";
import "remixicon/fonts/remixicon.css";

import Footer from "@components/layout/Footer.astro";
import Header from "@components/layout/Header.astro";
import Hero from "@components/layout/Hero.astro";
import MobileDrawerPanel from "@components/layout/MobileDrawerPanel.astro";
import Sidebar from "@components/layout/Sidebar.astro";
import BackToTop from "@components/widgets/BackToTop.astro";
import type { MarkdownHeading } from "astro";

const SITE_TITLE = "サン猫の時間漂流";
const SITE_DESCRIPTION = "一个孤独的地方，散落着一个人的人生碎片";
const SITE_AUTHOR = "EveSunMaple";
const OG_IMAGE_DEFAULT = "/default-social-image.png";
const TWITTER_HANDLE = "@EveSunMaple";
const GITHUB_URL = "https://github.com/EveSunMaple";
const TELEGRAM_URL = "https://t.me/saroprock";
const CHANNEL_URL = "https://t.me/saroprock";
const QQ_GROUP_NUMBER = "978990027";
const EMAIL_ADDRESS = "evesunmaple@outlook.com";

interface BreadcrumbItem {
  label: string;
  href?: string;
}

export interface Props {
  title: string;
  description?: string;
  image?: string;
  headings?: MarkdownHeading[];
  showHero?: boolean;
  breadcrumbs?: BreadcrumbItem[] | null;
}

const {
  title,
  description = SITE_DESCRIPTION,
  image = OG_IMAGE_DEFAULT,
  headings = [],
  showHero = title === "首页",
  breadcrumbs: providedBreadcrumbs,
} = Astro.props;

const finalTitle = title === "首页" ? SITE_TITLE : `${title} | ${SITE_TITLE}`;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const socialImageURL = new URL(image, Astro.site);
const currentPath = Astro.url.pathname;
const mobileDrawerId = "mobile-drawer";
const navLinks = [
  { href: "/", label: "首页" },
  { href: "/blog", label: "博客" },
  { href: "/friends", label: "朋友" },
  { href: "/guestbook", label: "留言" },
];

const navLookup = new Map(navLinks.map((link) => [link.href, link.label]));

const buildDefaultBreadcrumbs = () => {
  if (title === "首页") return null;

  const segments = currentPath.split("/").filter(Boolean);
  const crumbs: BreadcrumbItem[] = [{ label: "首页", href: "/" }];

  if (segments.length === 0) {
    crumbs.push({ label: title });
    return crumbs;
  }

  segments.forEach((_, index) => {
    const path = `/${segments.slice(0, index + 1).join("/")}`;
    const isLast = index === segments.length - 1;

    if (!isLast) {
      const label = navLookup.get(path) ?? segments[index];
      crumbs.push({ label, href: path });
    }
  });

  crumbs.push({ label: title });
  return crumbs;
};

const breadcrumbs = providedBreadcrumbs ?? buildDefaultBreadcrumbs();
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <meta name="author" content={SITE_AUTHOR} />

    <title>{finalTitle}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <link rel="icon" href="/favicon.ico" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/favicon.svg"
      media="(prefers-color-scheme: light)"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/favicon-dark.svg"
      media="(prefers-color-scheme: dark)"
    />

    <meta property="og:title" content={finalTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={SITE_TITLE} />
    <meta property="og:locale" content="zh_CN" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={TWITTER_HANDLE} />
    <meta name="twitter:title" content={finalTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={socialImageURL} />
  </head>
  <body class="bg-base-100 text-base-content min-h-screen topography">
    <Header
      siteTitle={SITE_TITLE}
      navLinks={navLinks}
      currentPath={currentPath}
      mobileDrawerId={mobileDrawerId}
    />

    <dialog id={mobileDrawerId} class="modal" aria-label="移动端导航">
      <div class="flex w-screen h-screen justify-start">
        <div
          class="w-80 max-w-[80vw] sm:max-w-sm h-full bg-base-100 shadow-2xl border-r border-base-content/10 flex flex-col drawer-panel"
        >
          <div class="bg-base-200/60 backdrop-blur-sm border-b border-base-content/10 p-5 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-linear-to-br from-primary to-secondary text-primary-content">
                <i class="ri-leaf-line" aria-hidden="true"></i>
              </span>
              <div>
                <p class="font-semibold">サン猫の時間漂流</p>
                <p class="text-xs text-base-content/60">所有的为时已晚都是恰逢其时</p>
              </div>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-ghost btn-circle"
              aria-label="关闭导航"
              data-close-drawer="true"
            >
              ✕
            </button>
          </div>
          <div class="p-5 space-y-6 overflow-y-auto flex-1">
            <nav class="flex flex-col gap-2" aria-label="主要导航">
              {navLinks.map((link) => {
                const isActive =
                  link.href === "/"
                    ? currentPath === "/"
                  : currentPath === link.href || currentPath.startsWith(`${link.href}/`);
                return (
                  <a
                    href={link.href}
                    class:list={{
                      "btn btn-ghost justify-start gap-3 rounded-xl": true,
                      "btn-active btn-primary text-primary-content": isActive,
                    }}
                    aria-current={isActive ? "page" : undefined}
                  >
                    <i class="ri-arrow-right-s-line" aria-hidden="true" />
                    <span>{link.label}</span>
                  </a>
                );
              })}
            </nav>

            <div class="divider my-4" />

            <MobileDrawerPanel
              author={SITE_AUTHOR}
              twitterHandle={TWITTER_HANDLE}
              githubUrl={GITHUB_URL}
              telegramUrl={TELEGRAM_URL}
              channelUrl={CHANNEL_URL}
              qqGroupNumber={QQ_GROUP_NUMBER}
              emailAddress={EMAIL_ADDRESS}
            />
          </div>
        </div>
        <button
          type="button"
          class="flex-1 h-full transition-colors duration-200"
          data-close-drawer="true"
          aria-label="点击关闭导航"
        >
          <span class="sr-only">关闭导航</span>
        </button>
      </div>
    </dialog>

    <style is:inline>
      .drawer-panel {
        transform: translateX(-100%);
      }
      @keyframes slideInDrawer {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(0);
        }
      }
      dialog[open] .drawer-panel {
        animation: slideInDrawer 0.3s ease forwards;
      }
      @keyframes slideOutDrawer {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(-100%);
        }
      }
      dialog .drawer-panel.animate-out {
        animation: slideOutDrawer 0.3s ease forwards;
      }
    </style>

    {showHero && <Hero siteDescription={SITE_DESCRIPTION} />}

    <div
      id="main-content-grid"
      class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8"
    >
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <main class="lg:col-span-3 min-h-[60vh]">
          {breadcrumbs && (
            <nav
              class="flex items-center gap-2 text-sm text-base-content/60 mb-8 no-print"
              aria-label="面包屑导航"
            >
              <ol class="flex items-center gap-2">
                {breadcrumbs.map((item, index) => {
                  const isLast = index === breadcrumbs.length - 1;
                  return (
                    <li class="flex items-center gap-2">
                      {index > 0 && (
                        <i class="ri-arrow-right-s-line text-base-content/40" aria-hidden="true"></i>
                      )}
                      {item.href && !isLast ? (
                        <a
                          href={item.href}
                          class="hover:text-primary transition-colors duration-200"
                        >
                          {item.label}
                        </a>
                      ) : (
                        <span
                          class:list={{
                            "text-base-content/80 font-medium": isLast,
                          }}
                        >
                          {item.label}
                        </span>
                      )}
                    </li>
                  );
                })}
              </ol>
            </nav>
          )}

          <slot />
        </main>

        <Sidebar
          headings={headings}
          author={SITE_AUTHOR}
          twitterHandle={TWITTER_HANDLE}
          githubUrl={GITHUB_URL}
          telegramUrl={TELEGRAM_URL}
          channelUrl={CHANNEL_URL}
          qqGroupNumber={QQ_GROUP_NUMBER}
          emailAddress={EMAIL_ADDRESS}
        />
      </div>
    </div>

    <Footer
      author={SITE_AUTHOR}
      twitterHandle={TWITTER_HANDLE}
      githubUrl={GITHUB_URL}
      telegramUrl={TELEGRAM_URL}
    />

    <BackToTop />
    <script is:inline define:vars={{ mobileDrawerId }}>
      const drawerId = mobileDrawerId;
      document.addEventListener("DOMContentLoaded", () => {
        const mobileDrawer = document.getElementById(drawerId);
        if (mobileDrawer instanceof HTMLDialogElement) {
          const panel = mobileDrawer.querySelector(".drawer-panel");

          const closeDrawer = () => {
            if (!mobileDrawer.open) return;
            if (!panel) {
              mobileDrawer.close();
              return;
            }
            panel.classList.add("animate-out");
            const handleAnimationEnd = () => {
              panel.classList.remove("animate-out");
              panel.removeEventListener("animationend", handleAnimationEnd);
              if (mobileDrawer.open) {
                mobileDrawer.close();
              }
            };
            panel.addEventListener("animationend", handleAnimationEnd, { once: true });
          };

          mobileDrawer.querySelectorAll("[data-close-drawer]").forEach((element) => {
            element.addEventListener("click", (event) => {
              event.preventDefault();
              closeDrawer();
            });
          });

          mobileDrawer.addEventListener("cancel", (event) => {
            event.preventDefault();
            closeDrawer();
          });

          mobileDrawer.addEventListener("close", () => {
            panel?.classList.remove("animate-out");
          });

          const observer = new MutationObserver(() => {
            if (mobileDrawer.open) {
              panel?.classList.remove("animate-out");
            }
          });
          observer.observe(mobileDrawer, { attributes: true, attributeFilter: ["open"] });
        }
      });
    </script>
  </body>
</html>
