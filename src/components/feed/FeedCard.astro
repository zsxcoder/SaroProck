---
import InlineComments from "@components/comments/InlineComments";
import type { TelegramPost } from "@/types";
import LikeButton from "./LikeButton.tsx";
import LinkPreview from "./LinkPreview.astro";
import MediaGallery from "./MediaGallery.astro";

interface Props {
  post: TelegramPost;
  isLastItem?: boolean;
}

const { post, isLastItem = false } = Astro.props;
---

<article class="dynamic-item group">
  <div class="grid grid-cols-[auto_1fr] gap-3">
    <div class="flex flex-col items-center">
      <div class="avatar mb-2">
        <div
          class="w-8 h-8 rounded-full ring-1 ring-primary/20 ring-offset-1 ring-offset-base-100 group-hover:ring-primary/40 transition-all duration-300"
        >
          <img src="/avatar.webp" alt="Channel Avatar" />
        </div>
      </div>
      {!isLastItem && (
        <div class="w-0.5 flex-1 bg-primary/30 rounded-full min-h-[1.5rem]" />
      )}
    </div>

    <div
      class="relative bg-base-200/30 backdrop-blur-sm rounded-xl border border-base-content/5 group-hover:border-primary/20 group-hover:bg-base-200/50 transition-all duration-300 group-hover:shadow-md"
    >
      <div class="p-4">
        <a
          href={`/post/${post.id}`}
          class="flex items-center justify-between mb-3"
        >
          <h2 class="font-medium text-sm text-base-content">
            サン猫の時間漂流
          </h2>
          <span class="text-xs text-base-content/60">{post.formattedDate}</span>
        </a>

        {post.reply && (
  <a
    href={post.reply.url}
    class="block not-prose no-underline mb-2 group/reply"
    target={post.reply.isExternal ? "_blank" : "_self"}
    rel={post.reply.isExternal ? "noopener noreferrer" : undefined}
  >
    <blockquote
      class:list={[
        "text-xs p-2 rounded-md border-l-2 transition-colors flex items-center gap-2",
        post.reply.isExternal
          ? "bg-warning/10 border-warning group-hover/reply:bg-warning/20"
          : "bg-base-300/30 border-primary group-hover/reply:bg-base-300/50",
      ]}
    >
      {post.reply.thumb && (
        <img
          src={post.reply.thumb}
          alt="Reply thumbnail"
          class="w-8 h-8 rounded-md flex-shrink-0 object-cover"
        />
      )}

      <div>
        <p class="font-bold text-base-content">
          {post.reply.author}
          {post.reply.isExternal && (
            <span class="ml-1 text-[0.65rem] px-1.5 py-0.5 rounded bg-warning/10 text-warning border border-warning/20">
              外部频道
            </span>
          )}
        </p>
        <p class="opacity-70 text-base-content/80 break-all" set:html={post.reply.html} />
      </div>
    </blockquote>
  </a>
)}

        <div
          class="prose prose-sm max-w-none mb-3 text-base-content/80 break-all text-sm leading-relaxed"
          set:html={post.htmlContent}
        />

        <MediaGallery media={post.media} postId={post.id} />

        {post.linkPreview && <LinkPreview link={post.linkPreview} />}

        <footer
          class="flex items-center justify-between pt-3 border-t border-base-content/5 mt-3"
        >
          <div class="flex items-center space-x-4 text-xs text-base-content/60">
            <div class="flex items-center space-x-1">
              <i class="ri-bar-chart-line text-sm"></i>
              <span>{post.views}</span>
            </div>
          </div>
          <div class="relative z-10 flex items-center space-x-1">
            <LikeButton postId={post.id} client:visible />
          </div>
        </footer>
      </div>

      <div class="border-t border-base-content/5 px-4 pt-2 pb-4">
        <InlineComments
          client:only="react"
          identifier={post.id}
          commentType="telegram"
        />
      </div>
    </div>
  </div>
</article>
