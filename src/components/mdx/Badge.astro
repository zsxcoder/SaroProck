---
export interface BadgeProps {
  img?: string;
  text?: string;
  link?: string;
  round?: boolean;
  square?: boolean;
}

const { img, text, link, round, square } = Astro.props as BadgeProps;

import {
  isExtLink,
  getDomain,
  safelyDecodeUriComponent,
} from "../../utils/icon";

// 获取 GitHub 用户名
function getGhUsername(url: string): string | null {
  if (!url) return null;
  const ghRegex = /github\.com\/(\w+)/i;
  const match = url.match(ghRegex);
  return match ? match[1] : null;
}

// 获取 GitHub 头像
function getGhAvatar(username: string): string {
  return `https://github.com/${username}.png`;
}

// 获取网站 favicon
function getFavicon(domain: string): string {
  return `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
}

// 计算要显示的图片
const computedImg =
  img ||
  (() => {
    if (link) {
      const ghUsername = getGhUsername(link);
      if (ghUsername) {
        return getGhAvatar(ghUsername);
      }
      if (isExtLink(link)) {
        return getFavicon(getDomain(link));
      }
    }
    return "";
  })();

// 计算是否为圆形样式
// 有图时默认为圆形样式，除非指定为方形
// 无图时默认为方形样式，除非指定为圆形
const computedRound = computedImg ? !square : !!round;

// 计算悬停提示文本
const tip = link
  ? isExtLink(link)
    ? getDomain(link)
    : safelyDecodeUriComponent(link)
  : "";
---

<a
  href={link}
  class={`badge ${computedRound ? 'round' : ''}`}
  target={link && isExtLink(link) ? '_blank' : undefined}
  rel={link && isExtLink(link) ? 'noopener noreferrer' : undefined}
  title={tip}
>
  {computedImg && (
    <img
      src={computedImg}
      alt={computedImg}
      class="badge-icon"
    />
  )}
  <span class="badge-text">
    <slot>{text}</slot>
  </span>
</a>

<style>
  /* 对齐到基线，同时保持图片垂直居中 */
  .badge {
    display: inline-flex;
    align-items: center;
    margin: 0.1em;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 4px;
    box-sizing: content-box;
    background-color: var(--color-bg-2, #f9fafb);
    font-size: 0.875em;
    transition: color 0.2s ease;
    color: var(--color-text, #111827);
    text-decoration: none;
  }

  @supports (color: color-mix(in srgb, transparent, transparent)) {
    .badge {
      border-color: color-mix(in srgb, currentcolor 10%, transparent);
      background-color: color-mix(in srgb, currentcolor 5%, transparent);
      color: color-mix(in srgb, currentcolor 80%, transparent);
    }
  }

  .badge:hover {
    color: var(--color-text, #111827);
  }

  .badge.round, .badge.round > .badge-icon {
    border-radius: 0.8em;
  }

  .badge-icon {
    height: 1.4em;
    width: 1.4em;
    border-radius: 3.5px;
    margin-right: 0.02em;
  }

  .badge-text {
    padding: 0.2em 0.4em;
    line-height: 1;
  }

  .badge-text:empty {
    display: none;
  }

  /* 深色模式适配 */
  html.dark .badge {
    border-color: var(--color-border, #374151);
    background-color: var(--color-bg-2, #1f2937);
    color: var(--color-text, #f9fafb);
  }

  @supports (color: color-mix(in srgb, transparent, transparent)) {
    html.dark .badge {
      border-color: color-mix(in srgb, currentcolor 10%, transparent);
      background-color: color-mix(in srgb, currentcolor 5%, transparent);
      color: color-mix(in srgb, currentcolor 80%, transparent);
    }
  }

  html.dark .badge:hover {
    color: var(--color-text, #f9fafb);
  }
</style>
