---
import { type CollectionEntry, getCollection } from "astro:content";
import BlogExplorer from "@components/blog/BlogExplorer";
import Layout from "@layouts/Layout.astro";

export const prerender = true;

type BlogEntry = CollectionEntry<"blog">;

interface Post {
  slug: string;
  title: string;
  description: string;
  categories: string[];
  tags: string[];
  words: number;
  readingMinutes: number;
  url: string;
  pubDate: string;
  coverImage: string | null;
}

const posts = await getCollection(
  "blog",
  (entry: BlogEntry) => entry.data.draft !== true,
);

const computeReadingMetrics = (body: string) => {
  const plainText = body.replace(/^---[\s\S]*?\n---\s*\n/, "");
  const chineseChars = (plainText.match(/[\u4e00-\u9fa5]/g) || []).length;
  const englishWords = (plainText.match(/[a-zA-Z0-9'-]+/g) || []).length;

  const chineseMinutes = chineseChars / 300;
  const englishMinutes = englishWords / 200;
  const totalMinutes = Math.max(1, Math.ceil(chineseMinutes + englishMinutes));
  const words = chineseChars + englishWords;

  return { words, totalMinutes };
};

const blogPosts: Post[] = posts
  .map((post: BlogEntry) => {
    const { words, totalMinutes } = computeReadingMetrics(post.body);

    return {
      slug: post.slug,
      title: post.data.title,
      description: post.data.description,
      categories: post.data.categories ?? [],
      tags: post.data.tags ?? [],
      words,
      readingMinutes: totalMinutes,
      url: `/blog/${post.slug}`,
      pubDate: new Date(post.data.pubDate).toISOString(),
      coverImage: post.data.image ?? null,
    };
  })
  .sort(
    (a: Post, b: Post) =>
      new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime(),
  );

const filterOptions = (() => {
  const categorySet = new Set<string>();
  const tagSet = new Set<string>();

  blogPosts.forEach((post) => {
    post.categories.forEach((category) => {
      categorySet.add(category);
    });
    post.tags.forEach((tag) => {
      tagSet.add(tag);
    });
  });

  return {
    categories: Array.from(categorySet).sort((a, b) =>
      a.localeCompare(b, "zh-CN"),
    ),
    tags: Array.from(tagSet).sort((a, b) => a.localeCompare(b, "zh-CN")),
  };
})();

const pageDescription =
  "浏览所有博客文章，通过标签与分类智能筛选，快速找到你感兴趣的内容。";
---

<Layout title="博客" description={pageDescription} showHero={false}>
  <BlogExplorer client:idle posts={blogPosts} filterOptions={filterOptions} />
</Layout>
