---
import Comments from "@components/comments/Comments.astro";
import LinkPreview from "@components/feed/LinkPreview.astro";
import PostMedia from "@components/post/PostMedia.astro";
import Layout from "@layouts/Layout.astro";
import LikeButton from "@/components/feed/LikeButton.tsx";
import { getPostById } from "@/lib/telegram";

const { id } = Astro.params;
if (!id) return Astro.redirect("/404");

const post = await getPostById(Astro, id);
if (!post) return Astro.redirect("/404");
---

<Layout title={`动态 #${post.id}`} description={post.text.substring(0, 150)}>
  <div class="max-w-5xl mx-auto">
    <div
      class="card lg:card-side bg-base-200/40 backdrop-blur-sm rounded-xl p-4 border border-base-content/5"
    >
      {
        post.media && post.media.length > 0 && (
          <figure class="lg:w-1/2 bg-base-200">
            <PostMedia media={post.media} />
          </figure>
        )
      }

      <div
        class:list={[
          "card-body flex flex-col",
          { "lg:w-1/2": post.media && post.media.length > 0 },
        ]}
      >
        <!-- Header -->
        <header class="flex items-center gap-3 mb-4 flex-shrink-0">
          <div class="avatar w-10 h-10">
            <div
              class="rounded-full ring ring-primary ring-offset-base-100 ring-offset-2"
            >
              <img src="/avatar.webp" alt="Channel Avatar" />
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-base-content">サン猫の時間漂流</h3>
            <p class="text-xs text-base-content/60">{post.formattedDate}</p>
          </div>
        </header>

        {post.reply && (
  <a
    href={post.reply.url}
    class="block not-prose no-underline mb-2 group/reply"
    target={post.reply.isExternal ? "_blank" : "_self"}
    rel={post.reply.isExternal ? "noopener noreferrer" : undefined}
  >
    <blockquote
      class:list={[
        "text-xs p-2 rounded-md border-l-2 transition-colors flex items-center gap-2",
        post.reply.isExternal
          ? "bg-warning/10 border-warning group-hover/reply:bg-warning/20"
          : "bg-base-300/30 border-primary group-hover/reply:bg-base-300/50",
      ]}
    >
      {post.reply.thumb && (
        <img
          src={post.reply.thumb}
          alt="Reply thumbnail"
          class="w-8 h-8 rounded-md flex-shrink-0 object-cover"
        />
      )}

      <div>
        <p class="font-bold text-base-content">
          {post.reply.author}
          {post.reply.isExternal && (
            <span class="ml-1 text-[0.65rem] px-1.5 py-0.5 rounded bg-warning/10 text-warning border border-warning/20">
              外部频道
            </span>
          )}
        </p>
        <p class="opacity-70 text-base-content/80 break-all" set:html={post.reply.html} />
      </div>
    </blockquote>
  </a>
)}

        <div class="flex-grow overflow-y-auto pr-2 -mr-2">
          <div
            class="prose prose-sm max-w-none text-base-content/90 leading-relaxed"
            set:html={post.htmlContent}
          />
          {post.linkPreview && <LinkPreview link={post.linkPreview} />}
        </div>

        <footer class="flex-shrink-0">
          <div
            class="flex items-center justify-between py-2 border-b border-t border-base-content/10 mt-4"
          >
            <div class="flex items-center space-x-1 text-sm">
              <i class="ri-bar-chart-line"></i><span>{post.views}</span>
            </div>
            <div class="relative z-10 flex items-center space-x-1">
              <LikeButton postId={post.id} client:visible />
            </div>
          </div>
        </footer>

        <div class="flex-shrink-0 pt-4">
          <Comments
            identifier={post.id}
            commentType="telegram"
            displayMode="full"
          />
        </div>
      </div>
    </div>
  </div>
</Layout>